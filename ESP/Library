local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")

local EruditeESP = {}

EruditeESP.Settings = {
    TextColour = Color3.fromRGB(255, 255, 255),
    VisualColour = Color3.fromRGB(255, 0, 0),
    TextSize = 16,
    ShowChams = true,
    ShowName = true,
    ShowDistance = true,
    ShowHealth = true,
    ShowTracers = true,
    RemoveOnDeath = true,
    MaxDistance = 300,
    TeamColors = false,
    TeamBased = false,
    EnableESP = true,
}

local espObjects = {}

function EruditeESP:Init(settings)
    for k, v in pairs(settings) do
        if self.Settings[k] ~= nil then
            self.Settings[k] = v
        end
    end
end

local function applyChams(character, color)
    if not character:FindFirstChild("Highlight") then
        local highlight = Instance.new("Highlight")
        highlight.FillColor = color
        highlight.OutlineColor = color
        highlight.FillTransparency = 0.5
        highlight.OutlineTransparency = 0.5
        highlight.Parent = character
    end
end

local function removeChams(character)
    if character:FindFirstChild("Highlight") then
        character.Highlight:Destroy()
    end
end

local function createBillboardGui(text, color, size)
    local billboardGui = Instance.new("BillboardGui")
    billboardGui.Size = UDim2.new(0, size * 10, 0, size * 2)
    billboardGui.AlwaysOnTop = true
    billboardGui.StudsOffset = Vector3.new(0, 3, 0)

    local textLabel = Instance.new("TextLabel")
    textLabel.Size = UDim2.new(1, 0, 1, 0)
    textLabel.BackgroundTransparency = 1
    textLabel.Text = text
    textLabel.TextColor3 = color
    textLabel.TextScaled = false
    textLabel.Font = Enum.Font.Code
    textLabel.TextSize = size
    textLabel.TextStrokeTransparency = 0.5
    textLabel.Parent = billboardGui

    return billboardGui
end

local function getDistance(position)
    local character = Players.LocalPlayer.Character
    if character and character:FindFirstChild("HumanoidRootPart") then
        local charPos = character.HumanoidRootPart.Position
        local magnitude = (charPos - position).Magnitude
        return math.floor(magnitude * 0.28) -- Converts studs to meters and rounds down
    end
    return 0
end

local function updateESP(player)
    if not EruditeESP.Settings.EnableESP then return end

    local character = player and player.Character
    if not character or not character:FindFirstChild("HumanoidRootPart") then
        return
    end

    local distance = getDistance(character.HumanoidRootPart.Position)
    if distance > EruditeESP.Settings.MaxDistance then
        if espObjects[player] then
            espObjects[player].BillboardGui.Enabled = false
            espObjects[player].Tracer.Visible = false
        end
        return
    end

    if not espObjects[player] then
        local billboardGui = createBillboardGui("", EruditeESP.Settings.TextColour, EruditeESP.Settings.TextSize)
        billboardGui.Parent = character.Head

        local tracer = Drawing.new("Line")
        tracer.Visible = false
        tracer.Color = EruditeESP.Settings.VisualColour
        tracer.Thickness = 1

        espObjects[player] = {
            BillboardGui = billboardGui,
            Tracer = tracer,
            Connection = RunService.Heartbeat:Connect(function()
                updateESP(player)
            end)
        }
    end

    local billboardGui = espObjects[player].BillboardGui
    local textLabel = billboardGui:FindFirstChildOfClass("TextLabel")

    local displayText = ""
    if EruditeESP.Settings.ShowName then
        displayText = player.Name
    end
    if EruditeESP.Settings.ShowHealth and character:FindFirstChild("Humanoid") then
        displayText = displayText .. " | " .. math.ceil(character.Humanoid.Health) .. " HP"
    end
    if EruditeESP.Settings.ShowDistance then
        displayText = displayText .. " | " .. distance .. " M"
    end

    textLabel.Text = displayText
    textLabel.TextSize = EruditeESP.Settings.TextSize
    billboardGui.Enabled = true

    if EruditeESP.Settings.ShowTracers then
        local screenPos, onScreen = workspace.CurrentCamera:WorldToViewportPoint(character.HumanoidRootPart.Position)
        if onScreen then
            local tracer = espObjects[player].Tracer
            if Players.LocalPlayer.Character and Players.LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
                local torsoPos = workspace.CurrentCamera:WorldToViewportPoint(Players.LocalPlayer.Character.HumanoidRootPart.Position)
                tracer.From = Vector2.new(torsoPos.X, torsoPos.Y)
                tracer.To = Vector2.new(screenPos.X, screenPos.Y)
                tracer.Visible = true
            end
        else
            espObjects[player].Tracer.Visible = false
        end
    end

    if EruditeESP.Settings.ShowChams then
        applyChams(character, EruditeESP.Settings.VisualColour)
    end
end

function EruditeESP:RemoveESP(player)
    if espObjects[player] then
        espObjects[player].BillboardGui:Destroy()
        espObjects[player].Tracer:Remove()
        if espObjects[player].Connection then
            espObjects[player].Connection:Disconnect()
        end
        removeChams(player.Character)
        espObjects[player] = nil
    end
end

function EruditeESP:InitializePlayers()
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= Players.LocalPlayer then
            self:InitializePlayer(player)
        end
    end

    Players.PlayerAdded:Connect(function(player)
        if player ~= Players.LocalPlayer then
            self:InitializePlayer(player)
        end
    end)

    Players.PlayerRemoving:Connect(function(player)
        self:RemoveESP(player)
    end)
end

function EruditeESP:InitializePlayer(player)
    player.CharacterAdded:Connect(function(character)
        character:WaitForChild("HumanoidRootPart")
        updateESP(player)
        if self.Settings.RemoveOnDeath then
            character:WaitForChild("Humanoid").Died:Connect(function()
                self:RemoveESP(player)
            end)
        end
    end)

    if player.Character then
        updateESP(player)
        if self.Settings.RemoveOnDeath then
            player.Character:WaitForChild("Humanoid").Died:Connect(function()
                self:RemoveESP(player)
            end)
        end
    end
end

local function updateObject(object)
    if not object:IsA("Model") and not object:IsA("BasePart") then return end
    local primaryPart = object:IsA("Model") and object.PrimaryPart or object
    if not primaryPart then return end

    local distance = getDistance(primaryPart.Position)
    if distance > EruditeESP.Settings.MaxDistance then
        if espObjects[object] then
            espObjects[object].BillboardGui.Enabled = false
            espObjects[object].Tracer.Visible = false
        end
        return
    end

    if not espObjects[object] then
        local billboardGui = createBillboardGui("", EruditeESP.Settings.TextColour, EruditeESP.Settings.TextSize)
        billboardGui.Parent = primaryPart

        local tracer = Drawing.new("Line")
        tracer.Visible = false
        tracer.Color = EruditeESP.Settings.VisualColour
        tracer.Thickness = 1

        espObjects[object] = {
            BillboardGui = billboardGui,
            Tracer = tracer,
            Connection = RunService.Heartbeat:Connect(function()
                updateObject(object)
            end)
        }
    end

    local billboardGui = espObjects[object].BillboardGui
    local textLabel = billboardGui:FindFirstChildOfClass("TextLabel")
    textLabel.Text = object.Name .. " | " .. distance .. " M"
    textLabel.TextSize = EruditeESP.Settings.TextSize
    billboardGui.Enabled = true

    if EruditeESP.Settings.ShowTracers then
        local screenPos, onScreen = workspace.CurrentCamera:WorldToViewportPoint(primaryPart.Position)
        if onScreen then
            local tracer = espObjects[object].Tracer
            if Players.LocalPlayer.Character and Players.LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
                local torsoPos = workspace.CurrentCamera:WorldToViewportPoint(Players.LocalPlayer.Character.HumanoidRootPart.Position)
                tracer.From = Vector2.new(torsoPos.X, torsoPos.Y)
                tracer.To = Vector2.new(screenPos.X, screenPos.Y)
                tracer.Visible = true
            end
        else
            espObjects[object].Tracer.Visible = false
        end
    end

    if EruditeESP.Settings.ShowChams then
        applyChams(object, EruditeESP.Settings.VisualColour)
    end
end

function EruditeESP:RemoveObject(object)
    if espObjects[object] then
        espObjects[object].BillboardGui:Destroy()
        espObjects[object].Tracer:Remove()
        if espObjects[object].Connection then
            espObjects[object].Connection:Disconnect()
        end
        removeChams(object)
        espObjects[object] = nil
    end
end

function EruditeESP:InitializeContainer(container)
    for _, item in pairs(container:GetChildren()) do
        updateObject(item)
    end

    container.ChildAdded:Connect(function(item)
        updateObject(item)
    end)

    container.ChildRemoved:Connect(function(item)
        self:RemoveObject(item)
    end)
end

function EruditeESP:InitializeObject(object)
    updateObject(object)
end

-- Reapply chams/glow periodically
RunService.Heartbeat:Connect(function()
    if not EruditeESP.Settings.EnableESP then return end
    for player, espData in pairs(espObjects) do
        if player:IsA("Player") and player.Character then
            applyChams(player.Character, EruditeESP.Settings.VisualColour)
        elseif player:IsA("Model") or player:IsA("BasePart") then
            applyChams(player, EruditeESP.Settings.VisualColour)
        end
    end
end)

return EruditeESP
