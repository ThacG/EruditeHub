local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")

local EruditeESP = {}

EruditeESP.Settings = {
    TextColour = Color3.fromRGB(255, 255, 255),
    VisualColour = Color3.fromRGB(255, 0, 0),
    TextSize = 8,
    ShowChams = true,
    ShowTracers = false,
    ShowBoxes = false,
    ShowName = true,
    ShowDistance = true,
    ShowHealth = true,
    RemoveOnDeath = true,
    UseMeters = false,
    MaxDistance = 300
}

function EruditeESP:Init(settings)
    local instance = setmetatable({}, {__index = self})
    
    instance.Settings = {}
    for k, v in pairs(self.Settings) do
        instance.Settings[k] = v
    end

    for k, v in pairs(settings) do
        if instance.Settings[k] ~= nil then
            instance.Settings[k] = v
        end
    end

    instance.espObjects = {}
    instance.espConnections = {}
    instance.espEnabled = true

    instance.initialisedPlayers = false
    instance.initialisedChildren = {}
    instance.initialisedDescendants = {}
    instance.initialisedChild = {}
    instance.initialisedDescendant = {}

    return instance
end

function EruditeESP:UpdateSettings(newSettings)
    for k, v in pairs(newSettings) do
        if self.Settings[k] ~= nil then
            self.Settings[k] = v
        end
    end
    self:ClearAllESP()
    if self.initialisedPlayers then
        self:InitialisePlayers()
    end
    if self.initialisedChildren then
        for container, _ in pairs(self.initialisedChildren) do
            self:InitialiseAllChildren(container)
        end
    end
    if self.initialisedDescendants then
        for container, _ in pairs(self.initialisedDescendants) do
            self:InitialiseAllDescendants(container)
        end
    end
    if self.initialisedChild then
        for parentPath, objectName in pairs(self.initialisedChild) do
            self:InitialiseChild(parentPath, objectName)
        end
    end
    if self.initialisedDescendant then
        for ancestorPath, objectName in pairs(self.initialisedDescendant) do
            self:InitialiseDescendant(ancestorPath, objectName)
        end
    end
end

local function applyChamsPlayer(character, color)
    if not character:FindFirstChild("Highlight") then
        local highlight = Instance.new("Highlight")
        highlight.FillColor = color
        highlight.OutlineColor = color
        highlight.FillTransparency = 0.5
        highlight.OutlineTransparency = 0.5
        highlight.Parent = character
    end
end

function EruditeESP:removeChams()
    for _, player in pairs(Players:GetPlayers()) do
        if player.Character then
            for _, child in pairs(player.Character:GetChildren()) do
                if child:IsA("Highlight") then
                    child:Destroy()
                end
            end
            for _, descendant in pairs(player.Character:GetDescendants()) do
                if descendant:IsA("Highlight") then
                    descendant:Destroy()
                end
            end
        end
    end

    for object, _ in pairs(self.espObjects) do
        if object:FindFirstChild("Highlight") then
            object.Highlight:Destroy()
        end
        for _, descendant in pairs(object:GetDescendants()) do
            if descendant:IsA("Highlight") then
                descendant:Destroy()
            end
        end
    end
end

local function createBillboardGui(text, color, size)
    local billboardGui = Instance.new("BillboardGui")
    billboardGui.Size = UDim2.new(0, size * 10, 0, size * 2)
    billboardGui.AlwaysOnTop = true
    billboardGui.StudsOffset = Vector3.new(0, 3, 0)

    local textLabel = Instance.new("TextLabel")
    textLabel.Size = UDim2.new(1, 0, 1, 0)
    textLabel.BackgroundTransparency = 1
    textLabel.Text = text
    textLabel.TextColor3 = color
    textLabel.TextScaled = false
    textLabel.Font = Enum.Font.Code
    textLabel.TextSize = size
    textLabel.TextStrokeTransparency = 0.5
    textLabel.Parent = billboardGui

    return billboardGui
end

local function createBox(self)
    local box = {}
    box.TopLeft = Drawing.new("Line")
    box.TopRight = Drawing.new("Line")
    box.BottomLeft = Drawing.new("Line")
    box.BottomRight = Drawing.new("Line")
    
    for _, line in pairs(box) do
        line.Visible = false
        line.Color = self.Settings.VisualColour
        line.Thickness = 1
    end
    
    return box
end

local function updateBox(box, item)
    local camera = Workspace.CurrentCamera
    local rootPart = nil
    local size = Vector3.new(2, 3, 0)

    if item:IsA("Model") then
        if item.PrimaryPart then
            rootPart = item.PrimaryPart
            size = item:GetExtentsSize() / 2
        else
            rootPart = item:FindFirstChildWhichIsA("BasePart")
            if rootPart then
                size = rootPart.Size / 2
            end
        end
    elseif item:IsA("BasePart") then
        rootPart = item
        size = item.Size / 2
    end

    if not rootPart then return end

    local points = {
        TopLeft = rootPart.CFrame * CFrame.new(-size.X, size.Y, 0),
        TopRight = rootPart.CFrame * CFrame.new(size.X, size.Y, 0),
        BottomLeft = rootPart.CFrame * CFrame.new(-size.X, -size.Y, 0),
        BottomRight = rootPart.CFrame * CFrame.new(size.X, -size.Y, 0)
    }

    for corner, cframe in pairs(points) do
        local vector, onScreen = camera:WorldToViewportPoint(cframe.Position)
        if onScreen then
            box[corner].Visible = true
            box[corner].From = Vector2.new(vector.X, vector.Y)
        else
            box[corner].Visible = false
        end
    end

    if box.TopLeft.Visible and box.TopRight.Visible and box.BottomLeft.Visible and box.BottomRight.Visible then
        box.TopLeft.To = box.TopRight.From
        box.TopRight.To = box.BottomRight.From
        box.BottomRight.To = box.BottomLeft.From
        box.BottomLeft.To = box.TopLeft.From
    else
        for _, line in pairs(box) do
            line.Visible = false
        end
    end
end

local function getDistance(position)
    local character = Players.LocalPlayer.Character
    if character and character:FindFirstChild("HumanoidRootPart") then
        local charPos = character.HumanoidRootPart.Position
        local magnitude = (charPos - position).Magnitude
        if EruditeESP.Settings.UseMeters then
            return math.floor(magnitude * 0.28)
        else
            return math.floor(magnitude)
        end
    end
    return 0
end

function EruditeESP:updateESP(player)
    if not self.espEnabled then return end

    local character = player and player.Character
    if not character or not character:FindFirstChild("HumanoidRootPart") then
        return
    end

    local distance = getDistance(character.HumanoidRootPart.Position)
    local unit = self.Settings.UseMeters and " M" or " Studs"

    if distance > self.Settings.MaxDistance then
        if self.espObjects[player] then
            self.espObjects[player].BillboardGui.Enabled = false
            self.espObjects[player].Tracer.Visible = false
            if self.espObjects[player].Box then
                for _, line in pairs(self.espObjects[player].Box) do
                    line.Visible = false
                end
            end
        end
        return
    end

    if not self.espObjects[player] then
        local billboardGui = createBillboardGui("", self.Settings.TextColour, self.Settings.TextSize)
        billboardGui.Parent = character.Head

        local tracer = Drawing.new("Line")
        tracer.Visible = false
        tracer.Color = self.Settings.VisualColour
        tracer.Thickness = 1
        
        local box = createBox(self)

        self.espObjects[player] = {
            BillboardGui = billboardGui,
            Tracer = tracer,
            Box = box,
            Connection = RunService.Heartbeat:Connect(function()
                self:updateESP(player)
            end)
        }
    end

    local billboardGui = self.espObjects[player].BillboardGui
    local textLabel = billboardGui:FindFirstChildOfClass("TextLabel")

    local displayText = ""
    if self.Settings.ShowName then
        displayText = player.Name
    end
    if self.Settings.ShowHealth and character:FindFirstChild("Humanoid") then
        local health = math.ceil(character.Humanoid.Health)
        displayText = displayText .. (displayText ~= "" and " | " or "") .. health .. " HP"
    end
    if self.Settings.ShowDistance then
        displayText = displayText .. (displayText ~= "" and " | " or "") .. distance .. unit
    end

    textLabel.Text = displayText
    textLabel.TextSize = self.Settings.TextSize
    billboardGui.Enabled = true

    if self.Settings.ShowTracers then
        local screenPos, onScreen = Workspace.CurrentCamera:WorldToViewportPoint(character.HumanoidRootPart.Position)
        if onScreen then
            local tracer = self.espObjects[player].Tracer
            if Players.LocalPlayer.Character and Players.LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
                local torsoPos = Workspace.CurrentCamera:WorldToViewportPoint(Players.LocalPlayer.Character.HumanoidRootPart.Position)
                tracer.From = Vector2.new(torsoPos.X, torsoPos.Y)
                tracer.To = Vector2.new(screenPos.X, screenPos.Y)
                tracer.Visible = true
            end
        else
            self.espObjects[player].Tracer.Visible = false
        end
    end

    if self.Settings.ShowChams then
        applyChamsPlayer(character, self.Settings.VisualColour)
    end
    
    if self.Settings.ShowBoxes then
        updateBox(self.espObjects[player].Box, character)
    end
end

function EruditeESP:RemoveESP(player)
    if self.espObjects[player] then
        if self.espObjects[player].BillboardGui then
            self.espObjects[player].BillboardGui:Destroy()
        end
        if self.espObjects[player].Tracer then
            self.espObjects[player].Tracer:Remove()
        end
        if self.espObjects[player].Box then
            for _, line in pairs(self.espObjects[player].Box) do
                line:Remove()
            end
        end
        if self.espObjects[player].Connection then
            self.espObjects[player].Connection:Disconnect()
        end
        self.espObjects[player] = nil
    end
end

function EruditeESP:InitialisePlayers()
    if not self.espEnabled then return end

    self.initialisedPlayers = true
    
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= Players.LocalPlayer then
            self:InitialisePlayer(player)
        end
    end

    table.insert(self.espConnections, Players.PlayerAdded:Connect(function(player)
        if player ~= Players.LocalPlayer then
            self:InitialisePlayer(player)
        end
    end))

    table.insert(self.espConnections, Players.PlayerRemoving:Connect(function(player)
        self:RemoveESP(player)
    end))
end

function EruditeESP:InitialisePlayer(player)
    if not self.espEnabled then return end

    local function characterAdded(character)
        character:WaitForChild("HumanoidRootPart")
        self:updateESP(player)
        if self.Settings.RemoveOnDeath then
            table.insert(self.espConnections, character:WaitForChild("Humanoid").Died:Connect(function()
                self:RemoveESP(player)
            end))
        end
    end

    table.insert(self.espConnections, player.CharacterAdded:Connect(characterAdded))

    if player.Character then
        characterAdded(player.Character)
    end
end

local function getItemPosition(item)
    if item:IsA("BasePart") then
        return item.Position
    elseif item:IsA("Model") then
        if item.PrimaryPart then
            return item.PrimaryPart.Position
        else
            local totalPosition = Vector3.new(0, 0, 0)
            local partCount = 0
            for _, part in pairs(item:GetChildren()) do
                if part:IsA("BasePart") then
                    totalPosition = totalPosition + part.Position
                    partCount = partCount + 1
                end
            end
            if partCount > 0 then
                return totalPosition / partCount
            end
        end
    end
    return nil
end

local function applyChamsObject(object, color)
    if not object:FindFirstChild("Highlight") then
        local highlight = Instance.new("Highlight")
        highlight.FillColor = color
        highlight.OutlineColor = color
        highlight.FillTransparency = 0.5
        highlight.OutlineTransparency = 0.5
        highlight.Parent = object
    end
end

function EruditeESP:updateObject(object)
    if not object:IsA("Model") and not object:IsA("BasePart") then return end
    local itemPos = getItemPosition(object)
    if not itemPos then return end

    local distance = getDistance(itemPos)
    local unit = self.Settings.UseMeters and " M" or " Studs"

    if distance > self.Settings.MaxDistance then
        if self.espObjects[object] then
            self.espObjects[object].BillboardGui.Enabled = false
            self.espObjects[object].Tracer.Visible = false
            if self.espObjects[object].Box then
                for _, line in pairs(self.espObjects[object].Box) do
                    line.Visible = false
                end
            end
        end
        return
    end

    if not self.espObjects[object] then
        local billboardGui = createBillboardGui("", self.Settings.TextColour, self.Settings.TextSize)
        billboardGui.Parent = object:IsA("Model") and object.PrimaryPart or object

        local tracer = Drawing.new("Line")
        tracer.Visible = false
        tracer.Color = self.Settings.VisualColour
        tracer.Thickness = 1

        local box = createBox(self)

        self.espObjects[object] = {
            BillboardGui = billboardGui,
            Tracer = tracer,
            Box = box,
            Connection = RunService.Heartbeat:Connect(function()
                self:updateObject(object)
            end)
        }
    end

    local billboardGui = self.espObjects[object].BillboardGui
    local textLabel = billboardGui:FindFirstChildOfClass("TextLabel")
    textLabel.Text = object.Name .. " | " .. distance .. unit
    textLabel.TextSize = self.Settings.TextSize
    billboardGui.Enabled = true

    if self.Settings.ShowTracers then
        local screenPos, onScreen = workspace.CurrentCamera:WorldToViewportPoint(itemPos)
        if onScreen then
            local tracer = self.espObjects[object].Tracer
            if Players.LocalPlayer.Character and Players.LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
                local torsoPos = workspace.CurrentCamera:WorldToViewportPoint(Players.LocalPlayer.Character.HumanoidRootPart.Position)
                tracer.From = Vector2.new(torsoPos.X, torsoPos.Y)
                tracer.To = Vector2.new(screenPos.X, screenPos.Y)
                tracer.Visible = true
            end
        else
            self.espObjects[object].Tracer.Visible = false
        end
    end

    if self.Settings.ShowChams then
        applyChamsObject(object, self.Settings.VisualColour)
    end

    if self.Settings.ShowBoxes then
        updateBox(self.espObjects[object].Box, object)
    end
end

function EruditeESP:RemoveObject(object)
    if self.espObjects[object] then
        if self.espObjects[object].BillboardGui then
            self.espObjects[object].BillboardGui:Destroy()
        end
        if self.espObjects[object].Tracer then
            self.espObjects[object].Tracer:Remove()
        end
        if self.espObjects[object].Box then
            for _, line in pairs(self.espObjects[object].Box) do
                line:Remove()
            end
        end
        if self.espObjects[object].Connection then
            self.espObjects[object].Connection:Disconnect()
        end
        self.espObjects[object] = nil
    end
end

function EruditeESP:InitialiseAllChildren(container)
    if not self.espEnabled then return end

    self.initialisedChildren[container] = true

    for _, item in pairs(container:GetChildren()) do
        self:updateObject(item)
    end

    table.insert(self.espConnections, container.ChildAdded:Connect(function(item)
        self:updateObject(item)
    end))

    table.insert(self.espConnections, container.ChildRemoved:Connect(function(item)
        self:RemoveObject(item)
    end))
end

function EruditeESP:InitialiseAllDescendants(container)
    if not self.espEnabled then return end

    self.initialisedDescendants[container] = true

    for _, item in pairs(container:GetDescendants()) do
        self:updateObject(item)
    end

    table.insert(self.espConnections, container.DescendantAdded:Connect(function(descendant)
        self:updateObject(descendant)
    end))

    table.insert(self.espConnections, container.DescendantRemoving:Connect(function(descendant)
        self:RemoveObject(descendant)
    end))
end

function EruditeESP:InitialiseChild(parentPath, objectName)
    if not self.espEnabled then return end

    if not self.initialisedChild[parentPath] then
        self.initialisedChild[parentPath] = {}
    end
    table.insert(self.initialisedChild[parentPath], objectName)

    local function updateIfExists()
        for _, child in pairs(parentPath:GetChildren()) do
            if child.Name == objectName then
                self:updateObject(child)
            end
        end
    end

    updateIfExists()

    table.insert(self.espConnections, parentPath.ChildAdded:Connect(function(child)
        if child.Name == objectName then
            self:updateObject(child)
        end
    end))

    table.insert(self.espConnections, parentPath.ChildRemoved:Connect(function(child)
        if child.Name == objectName then
            self:RemoveObject(child)
        end
    end))
end

function EruditeESP:InitialiseDescendant(ancestorPath, objectName)
    if not self.espEnabled then return end

    if not self.initialisedDescendant[ancestorPath] then
        self.initialisedDescendant[ancestorPath] = {}
    end
    table.insert(self.initialisedDescendant[ancestorPath], objectName)

    local function updateDescendants(parent)
        for _, descendant in pairs(parent:GetDescendants()) do
            if descendant.Name == objectName then
                self:updateObject(descendant)
            end
        end
    end

    updateDescendants(ancestorPath)

    table.insert(self.espConnections, ancestorPath.DescendantAdded:Connect(function(descendant)
        if descendant.Name == objectName then
            self:updateObject(descendant)
        end
    end))

    table.insert(self.espConnections, ancestorPath.DescendantRemoving:Connect(function(descendant)
        if descendant.Name == objectName then
            self:RemoveObject(descendant)
        end
    end))
end

function EruditeESP:ClearAllESP()
    self:removeChams()
    for object, _ in pairs(self.espObjects) do
        self:RemoveObject(object)
    end
    for _, connection in pairs(self.espConnections) do
        connection:Disconnect()
    end
    self.espConnections = {}
end

function EruditeESP:ClearESP(instance)
    instance:ClearAllESP()
end

return EruditeESP
